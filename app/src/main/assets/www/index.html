<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dr. Morris Brutal Muscle</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{background:#08080F;color:#E2E8F0;font-family:'DM Sans',system-ui,sans-serif;height:100%;-webkit-text-size-adjust:100%;overscroll-behavior:none;}
button{outline:none;-webkit-tap-highlight-color:transparent;font-family:inherit;}
::-webkit-scrollbar{width:0;}
#app{max-width:480px;margin:0 auto;min-height:100vh;padding-bottom:100px;}

/* HEADER */
#header{position:sticky;top:0;z-index:20;background:rgba(8,8,15,0.95);backdrop-filter:blur(16px);border-bottom:1px solid #818CF820;}
#appbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;}
.logo-wrap{display:flex;align-items:center;gap:10px;}
.logo-img{width:40px;height:40px;border-radius:12px;border:2px solid #818CF850;background:#0D0D1F;overflow:hidden;object-fit:cover;}
.app-title{font-size:13px;font-weight:800;letter-spacing:-0.5px;line-height:1.2;}
.app-sub{color:#818CF8;}
.app-date{font-size:10px;color:#4B5563;margin-top:1px;}
.done-badge{display:flex;align-items:center;gap:5px;background:#052e1c;border:1px solid #34D39940;border-radius:20px;padding:4px 10px;font-size:10px;color:#34D399;font-weight:700;}

/* DAY SELECTOR */
#days{display:flex;padding:0 10px 12px;gap:5px;}
.day-btn{flex:1;padding:7px 2px;border-radius:10px;border:2px solid transparent;background:#111120;cursor:pointer;position:relative;display:flex;flex-direction:column;align-items:center;gap:1px;transition:all 0.18s;}
.day-btn.active{background:#818CF818;}
.day-short{font-size:13px;font-weight:500;color:#374151;transition:color 0.18s;}
.day-btn.active .day-short{font-weight:800;}
.day-num{font-size:9px;color:#1F2937;}
.day-dot{position:absolute;top:3px;right:3px;width:5px;height:5px;border-radius:50%;background:#34D399;}
.day-today{position:absolute;bottom:4px;width:3px;height:3px;border-radius:50%;opacity:0.8;}

/* TOAST */
#toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);border-radius:12px;padding:11px 18px;font-size:13px;font-weight:700;z-index:999;box-shadow:0 20px 60px rgba(0,0,0,0.7);white-space:nowrap;max-width:280px;text-align:center;display:none;border:1px solid #374151;}
#toast.show{display:block;animation:pop 0.35s cubic-bezier(0.34,1.56,0.64,1) forwards;}
@keyframes pop{0%{transform:scale(0.85) translateX(-50%);opacity:0;}60%{transform:scale(1.05) translateX(-50%);}100%{transform:scale(1) translateX(-50%);opacity:1;}}

/* TITLE */
#routine-header{padding:18px 16px 10px;}
.routine-row{display:flex;align-items:flex-start;justify-content:space-between;}
.routine-day-label{font-size:10px;color:#4B5563;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:3px;}
.routine-name{font-size:26px;font-weight:800;letter-spacing:-0.8px;line-height:1.1;}
.routine-count{background:#111120;border-radius:10px;padding:6px 10px;text-align:center;flex-shrink:0;}
.routine-count-num{font-size:18px;font-weight:800;}
.routine-count-lbl{font-size:9px;color:#4B5563;text-transform:uppercase;letter-spacing:0.5px;}
.future-warn{margin-top:10px;display:flex;align-items:center;gap:6px;background:#1A1200;border:1px solid #FBBF2430;border-radius:8px;padding:7px 12px;font-size:11px;color:#FBBF24;}

/* EXERCISES */
#exercises{padding:0 12px;}
.ex-complement{display:flex;align-items:center;gap:10px;padding:9px 12px;background:#0E0E1A;border-radius:10px;margin-bottom:6px;border:1px solid #1A1A28;}
.ex-icon{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:11px;}
.ex-comp-name{font-size:13px;color:#6B7280;flex:1;}
.ex-comp-sets{font-size:12px;color:#374151;}

.ex-card{background:#0F0F1C;border-radius:14px;margin-bottom:8px;border:1px solid #1A1A28;overflow:hidden;transition:border-color 0.2s;}
.ex-card.open{border-color:#818CF830;}
.ex-header{width:100%;background:none;border:none;cursor:pointer;padding:12px 14px;display:flex;align-items:center;gap:10px;}
.ex-dot{width:7px;height:7px;border-radius:50%;background:#374151;flex-shrink:0;transition:background 0.2s;}
.ex-card.open .ex-dot{background:#818CF8;}
.ex-name{font-size:14px;font-weight:700;color:#9CA3AF;text-align:left;flex:1;line-height:1.3;transition:color 0.2s;}
.ex-card.open .ex-name{color:#E2E8F0;}
.ex-header-right{display:flex;align-items:center;gap:6px;}
.ex-preview{font-size:11px;color:#374151;}
.chart-btn{background:#818CF818;border:none;cursor:pointer;width:28px;height:28px;border-radius:7px;color:#818CF8;display:flex;align-items:center;justify-content:center;font-size:13px;}
.chevron{font-size:14px;color:#374151;}

.ex-body{animation:fadeSlide 0.18s ease-out;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.ex-note{padding:5px 14px 7px;display:flex;align-items:center;gap:6px;font-size:11px;color:#6B7280;font-style:italic;}
.ex-divider{height:1px;background:#1A1A28;}
.ex-group{padding:9px 14px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #13131F;}
.ex-group:last-child{border-bottom:none;}
.ex-group.warmup{background:#0D1526;}
.group-info{flex:1;min-width:0;}
.group-label{font-size:9px;font-weight:700;color:#4B5563;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:2px;}
.group-label.warmup{color:#B45309;}
.group-sets{font-size:13px;color:#CBD5E1;}
.group-sets.warmup{color:#6B7280;}

/* WEIGHT CTRL */
.weight-ctrl{display:flex;align-items:center;gap:5px;}
.w-btn{width:34px;height:34px;border-radius:9px;border:1.5px solid #818CF835;background:#818CF812;color:#818CF8;font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation;flex-shrink:0;font-weight:300;}
.w-val{min-width:68px;text-align:center;font-size:13px;font-weight:700;color:#E2E8F0;letter-spacing:-0.3px;font-variant-numeric:tabular-nums;}

/* COMPLEMENT FOOTER */
.complement-footer{text-align:center;font-size:11px;color:#2A2A3E;padding:4px 0 8px;}

/* BOTTOM BAR */
#bottom-bar{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;padding:10px 12px 22px;background:linear-gradient(to top,#08080F 65%,transparent);}
#finish-btn{width:100%;padding:15px;border-radius:14px;border:none;font-size:15px;font-weight:800;letter-spacing:-0.3px;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;transition:all 0.2s;font-family:inherit;}

/* MODAL */
#modal{position:fixed;inset:0;z-index:60;background:rgba(0,0,0,0.8);display:none;align-items:flex-end;backdrop-filter:blur(4px);}
#modal.show{display:flex;}
#modal-inner{background:#111120;border-radius:22px 22px 0 0;padding:20px 16px 40px;width:100%;border:1px solid #2A2A3E;max-height:88vh;overflow-y:auto;}
.modal-handle{width:36px;height:4px;border-radius:2px;background:#2A2A3E;margin:0 auto 18px;}
.modal-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;}
.modal-close{background:#1E1E30;border:none;cursor:pointer;width:32px;height:32px;border-radius:8px;color:#6B7280;font-size:16px;}
.modal-ex-name{font-size:19px;font-weight:800;color:#E2E8F0;letter-spacing:-0.4px;}
.modal-label{font-size:10px;color:#4B5563;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;}
.no-data{text-align:center;padding:48px 0 20px;color:#374151;}
.no-data-title{font-size:15px;font-weight:700;margin-bottom:6px;color:#4B5563;}
.no-data-sub{font-size:12px;line-height:1.6;}

.stat-card{background:#161625;border-radius:10px;padding:10px 12px;border:1px solid #818CF820;display:flex;gap:10px;margin-bottom:8px;}
.stat-bar{width:3px;align-self:stretch;border-radius:2px;flex-shrink:0;}
.stat-label{font-size:10px;color:#4B5563;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;}
.stat-nums{display:flex;gap:20px;}
.stat-item-label{font-size:9px;color:#4B5563;margin-bottom:2px;}
.stat-item-val{font-size:14px;font-weight:800;}

/* SVG chart */
.chart-wrap{background:#0D0D1A;border-radius:12px;padding:12px 8px 8px;margin-bottom:12px;overflow:hidden;}
</style>
</head>
<body>
<div id="app">
  <div id="header">
    <div id="appbar">
      <div class="logo-wrap">
        <img class="logo-img" src="ic_launcher.png" alt="Dr. Morris" onerror="this.style.display='none'"/>
        <div>
          <div class="app-title">Dr. Morris<br/><span class="app-sub">Brutal Muscle</span></div>
          <div class="app-date" id="today-label"></div>
        </div>
      </div>
      <div class="done-badge" id="done-badge" style="display:none">‚úì COMPLETADO</div>
    </div>
    <div id="days"></div>
  </div>

  <div id="toast"></div>

  <div id="routine-header">
    <div class="routine-row">
      <div>
        <div class="routine-day-label" id="day-label"></div>
        <div class="routine-name" id="routine-name"></div>
      </div>
      <div class="routine-count">
        <div class="routine-count-num" id="ex-count"></div>
        <div class="routine-count-lbl">ejercicios</div>
      </div>
    </div>
    <div class="future-warn" id="future-warn" style="display:none">‚ö† Puedes preparar los pesos con antelaci√≥n</div>
  </div>

  <div id="exercises"></div>

  <div id="bottom-bar">
    <button id="finish-btn" onclick="handleFinish()">‚úì Finalizar entrenamiento</button>
  </div>
</div>

<div id="modal" onclick="closeModal()">
  <div id="modal-inner" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div><div class="modal-label">Progresi√≥n ¬∑ ¬±100g</div><div class="modal-ex-name" id="modal-title"></div></div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
const WORKOUTS = [
  {day:"Lunes",short:"L",name:"Push",color:"#818CF8",exercises:[
    {id:"L0",name:"Press pecho MP",hw:true,note:null,groups:[{l:"Calent.",s:2,r:"10",dw:20},{l:"Serie A",s:2,r:"12",dw:30},{l:"Serie B",s:2,r:"10",dw:32.5}]},
    {id:"L1",name:"Aperturas inclinadas",hw:true,note:"Bajada peso hasta el fallo",groups:[{l:"Serie A",s:2,r:"12",dw:10.25},{l:"Serie B",s:2,r:"10",dw:14}]},
    {id:"L2",name:"P√°jaros alternos m√°quina",hw:true,note:null,groups:[{l:"Serie A",s:1,r:"15",dw:45},{l:"Serie B",s:3,r:"12",dw:47}]},
    {id:"L3",name:"Press hombros",hw:true,note:null,groups:[{l:"Calent.",s:1,r:"10",dw:14},{l:"Serie A",s:2,r:"12",dw:29},{l:"Serie B",s:2,r:"10",dw:32}]},
    {id:"L4",name:"Elevaci√≥n lateral polea",hw:true,note:"Bajada al fallo",groups:[{l:"Serie A",s:1,r:"15",dw:6.25},{l:"Serie B",s:3,r:"12",dw:9}]},
    {id:"L5",name:"Extensi√≥n",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"12",dw:5},{l:"Serie B",s:2,r:"10",dw:6}]},
    {id:"L6",name:"Extensi√≥n tr√≠ceps",hw:true,note:"Bajada al fallo",groups:[{l:"Serie A",s:1,r:"15",dw:28.25},{l:"Serie B",s:3,r:"12",dw:32}]},
    {id:"L7",name:"Giros rusos",hw:true,note:null,groups:[{l:"Serie",s:3,r:"20 (total)",dw:12}]},
    {id:"L8",name:"Escaladores",hw:false,note:null,groups:[{l:"",s:3,r:"1 min",dw:null}]},
  ]},
  {day:"Martes",short:"Ma",name:"Espalda ¬∑ B√≠ceps",color:"#F472B6",exercises:[
    {id:"M0",name:"Remo inclinado",hw:true,note:null,groups:[{l:"Serie",s:3,r:"10",dw:42.5}]},
    {id:"M1",name:"Jal√≥n lateral",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"12",dw:46.25},{l:"Serie B",s:2,r:"10",dw:50}]},
    {id:"M2",name:"Close lateral pull",hw:true,note:"√öltima: +4 reps parciales",groups:[{l:"Serie",s:3,r:"12",dw:46.25}]},
    {id:"M3",name:"Jal√≥n brazo recto",hw:true,note:null,groups:[{l:"Serie A",s:3,r:"12",dw:36},{l:"Serie B",s:1,r:"6",dw:20}]},
    {id:"M4",name:"Jal√≥n a la cara",hw:true,note:null,groups:[{l:"Serie",s:3,r:"15",dw:29.5}]},
    {id:"M5",name:"Curl predicador",hw:true,note:null,groups:[{l:"Serie",s:3,r:"12",dw:10}]},
    {id:"M6",name:"B√≠ceps martillo con cuerda",hw:true,note:null,groups:[{l:"Serie A",s:3,r:"12",dw:32},{l:"Serie B",s:1,r:"6",dw:27}]},
  ]},
  {day:"Mi√©rcoles",short:"X",name:"Pierna",color:"#34D399",exercises:[
    {id:"W0",name:"Caminar en cinta",hw:false,note:null,groups:[{l:"",s:1,r:"10 min",dw:null}]},
    {id:"W1",name:"Sentadilla MP",hw:true,note:null,groups:[{l:"Serie",s:3,r:"8",dw:37.5}]},
    {id:"W2",name:"Press pierna",hw:true,note:null,groups:[{l:"Serie",s:3,r:"12",dw:109}]},
    {id:"W3",name:"Sentadilla b√∫lgara",hw:true,note:"Alt: press pierna 36 kg",groups:[{l:"Serie",s:3,r:"10",dw:10}]},
    {id:"W4",name:"Extensi√≥n cu√°druple",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"15",dw:52},{l:"Serie B",s:1,r:"12",dw:56},{l:"Serie C",s:1,r:"8",dw:59}]},
    {id:"W5",name:"Peso muerto rumano",hw:true,note:null,groups:[{l:"Serie",s:3,r:"10",dw:25}]},
    {id:"W6",name:"Curl isquios",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"15",dw:45},{l:"Serie B",s:1,r:"12",dw:47},{l:"Serie C",s:1,r:"8",dw:50}]},
    {id:"W7",name:"Abducci√≥n cadera",hw:true,note:null,groups:[{l:"Serie",s:3,r:"12",dw:41}]},
    {id:"W8",name:"Aducci√≥n cadera",hw:true,note:null,groups:[{l:"Serie",s:3,r:"12",dw:50}]},
    {id:"W9",name:"Rodillo",hw:false,note:null,groups:[{l:"",s:3,r:"10",dw:null}]},
    {id:"W10",name:"Transporte cargado",hw:false,note:null,groups:[{l:"",s:3,r:"40 seg",dw:null}]},
  ]},
  {day:"Jueves",short:"J",name:"Push II",color:"#FBBF24",exercises:[
    {id:"J0",name:"Press pecho",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"12",dw:36},{l:"Serie B",s:1,r:"8",dw:41},{l:"Serie C",s:1,r:"6",dw:43}]},
    {id:"J1",name:"Press pecho inclinado",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"15",dw:25},{l:"Serie B",s:2,r:"10",dw:27.5}]},
    {id:"J2",name:"Cruce poleas altas",hw:true,note:"Bajada al fallo",groups:[{l:"Serie",s:3,r:"15",dw:18}]},
    {id:"J3",name:"Elevaci√≥n lateral 1 mano",hw:true,note:"1√ó12 bajada 5 kg",groups:[{l:"Serie A",s:1,r:"15",dw:6.25},{l:"Serie B",s:3,r:"12",dw:9}]},
    {id:"J4",name:"Elevaci√≥n frontal",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"15",dw:10.25},{l:"Serie B",s:2,r:"12",dw:14}]},
    {id:"J5",name:"Extensi√≥n cruzada 1 brazo",hw:true,note:null,groups:[{l:"Serie A",s:1,r:"12",dw:14},{l:"Serie B",s:3,r:"10",dw:15.25}]},
    {id:"J6",name:"Fondos",hw:false,note:null,groups:[{l:"",s:2,r:"15",dw:null},{l:"Fallo",s:1,r:"fallo",dw:null}]},
  ]},
  {day:"Viernes",short:"V",name:"Pull",color:"#F87171",exercises:[
    {id:"V0",name:"Dominadas",hw:true,note:null,groups:[{l:"Serie A",s:1,r:"10",dw:18},{l:"Serie B",s:3,r:"12",dw:14}]},
    {id:"V1",name:"Remo escapulares",hw:true,note:null,groups:[{l:"Serie",s:3,r:"12",dw:54}]},
    {id:"V2",name:"Tir√≥n arrodillado",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"12",dw:36},{l:"Serie B",s:2,r:"10",dw:37.25}]},
    {id:"V3",name:"Remo inclinado",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"12",dw:21.25},{l:"Serie B",s:1,r:"10",dw:22.5},{l:"Serie C",s:1,r:"8",dw:25}]},
    {id:"V4",name:"Jal√≥n a la cara",hw:true,note:null,groups:[{l:"Serie A",s:2,r:"15",dw:29.5},{l:"Serie B",s:2,r:"12",dw:32}]},
    {id:"V5",name:"Curl martillo",hw:true,note:null,groups:[{l:"Serie A",s:1,r:"15",dw:9},{l:"Serie B",s:3,r:"12",dw:10}]},
    {id:"V6",name:"Curl b√≠ceps banco 1 mano",hw:true,note:null,groups:[{l:"Serie A",s:1,r:"15",dw:8},{l:"Serie B",s:3,r:"12",dw:9},{l:"Serie C",s:1,r:"12",dw:7.5}]},
    {id:"V7",name:"Press antirotaci√≥n",hw:false,note:null,groups:[{l:"",s:3,r:"45s c/lado",dw:null}]},
    {id:"V8",name:"Crunch bicicleta",hw:false,note:null,groups:[{l:"",s:3,r:"30",dw:null}]},
  ]},
];

// STATE
var today = new Date();
var todayDow = today.getDay();
var todayStr = today.toISOString().split("T")[0];
var selDay = (todayDow>=1&&todayDow<=5) ? todayDow-1 : (todayDow===6?4:0);
var weights = {};
var completed = {};
var expanded = {};
var ivRef = null;

function weekDate(wIdx) {
  var d = new Date(today);
  d.setDate(d.getDate() + (wIdx+1-todayDow));
  return d.toISOString().split("T")[0];
}
function fmtW(w) {
  if(w===null||w===undefined) return "‚Äî";
  return parseFloat(w.toFixed(2))+" kg";
}
function adj(w,d) { return Math.max(0, Math.round(((w||0)+d)*100)/100); }

// STORAGE
function storageGet(k) { try{ var v=localStorage.getItem(k); return v?JSON.parse(v):null; }catch(e){return null;} }
function storageSet(k,v) { try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} }

// INIT
function init() {
  var saved = storageGet("gymCompleted");
  if(saved) completed = saved;

  document.getElementById("today-label").textContent =
    today.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"short"});

  renderDays();
  loadDay(selDay);
}

function loadDay(idx) {
  selDay = idx;
  var selDate = weekDate(idx);
  var saved = storageGet("gymSess_"+selDate);
  if(saved) {
    weights = saved;
  } else {
    weights = {};
    WORKOUTS[idx].exercises.forEach(function(ex){
      ex.groups.forEach(function(g,gi){ if(g.dw!==null) weights[ex.id+"_"+gi]=g.dw; });
    });
  }
  // expand all weighted by default
  expanded = {};
  WORKOUTS[idx].exercises.forEach(function(ex){ if(ex.hw) expanded[ex.id]=true; });

  renderDays();
  renderRoutineHeader();
  renderExercises();
  renderBottomBar();
}

function renderDays() {
  var c = WORKOUTS[selDay].color;
  // update header border
  document.getElementById("header").style.borderBottom = "1px solid "+c+"18";

  var html = "";
  WORKOUTS.forEach(function(w,i){
    var date = weekDate(i);
    var done = !!completed[date];
    var isT = date===todayStr;
    var isSel = i===selDay;
    html += '<button class="day-btn'+(isSel?" active":"") +'" onclick="loadDay('+i+')" '+
      'style="border-color:'+(isSel?w.color:"transparent")+';background:'+(isSel?w.color+"18":"#111120")+'">' +
      '<span class="day-short" style="color:'+(isSel?w.color:isT?"#6B7280":"#374151")+'">'+ w.short +'</span>'+
      '<span class="day-num">'+ weekDate(i).slice(8) +'</span>'+
      (done?'<div class="day-dot"></div>':'')+
      (isT?'<div class="day-today" style="background:'+w.color+'"></div>':'')+
      '</button>';
  });
  document.getElementById("days").innerHTML = html;
}

function renderRoutineHeader() {
  var w = WORKOUTS[selDay];
  var selDate = weekDate(selDay);
  var isWeekday = todayDow>=1&&todayDow<=5;
  var isFuture = isWeekday && selDate>todayStr;
  var isDone = !!completed[selDate];
  var totalW = w.exercises.filter(function(e){return e.hw;}).length;

  document.getElementById("day-label").textContent = w.day+(isFuture?" ¬∑ pr√≥xima sesi√≥n":"");
  document.getElementById("routine-name").style.color = w.color;
  document.getElementById("routine-name").textContent = w.name;
  document.getElementById("ex-count").style.color = w.color;
  document.getElementById("ex-count").textContent = totalW;
  document.getElementById("routine-count").style.border = "1px solid "+w.color+"20";
  document.getElementById("future-warn").style.display = isFuture?"flex":"none";

  var badge = document.getElementById("done-badge");
  badge.style.display = isDone?"flex":"none";
}

function renderExercises() {
  var w = WORKOUTS[selDay];
  var C = w.color;
  var html = "";

  w.exercises.forEach(function(ex){
    if(!ex.hw) {
      html += '<div class="ex-complement">'+
        '<div class="ex-icon" style="background:'+C+'18;color:'+C+'">üî•</div>'+
        '<span class="ex-comp-name">'+ex.name+'</span>'+
        '<span class="ex-comp-sets">'+ex.groups.map(function(g){return g.s+"√ó"+g.r;}).join(" ¬∑ ")+'</span>'+
        '</div>';
      return;
    }

    var isOpen = !!expanded[ex.id];
    html += '<div class="ex-card'+(isOpen?" open":"")+'" id="card-'+ex.id+'" style="'+(isOpen?"border-color:"+C+"30":"")+'">'+
      '<button class="ex-header" onclick="toggleEx(\''+ex.id+'\')">'+
        '<div class="ex-dot" style="background:'+(isOpen?C:"#374151")+'"></div>'+
        '<span class="ex-name">'+ex.name+'</span>'+
        '<div class="ex-header-right">'+
          (!isOpen && ex.groups[0] && ex.groups[0].dw!==null ?
            '<span class="ex-preview">'+fmtW(weights[ex.id+"_0"]!=null?weights[ex.id+"_0"]:ex.groups[0].dw)+'</span>' : '')+
          '<button class="chart-btn" onclick="event.stopPropagation();openChart(\''+ex.id+'\')">üìà</button>'+
          '<span class="chevron">'+(isOpen?"‚ñ≤":"‚ñº")+'</span>'+
        '</div>'+
      '</button>';

    if(isOpen) {
      html += '<div class="ex-body">';
      if(ex.note) html += '<div class="ex-note"><span>‚ÑπÔ∏è</span> '+ex.note+'</div>';
      html += '<div class="ex-divider"></div>';

      ex.groups.forEach(function(g,gi){
        var key = ex.id+"_"+gi;
        var val = weights[key]!=null ? weights[key] : g.dw;
        var isC = g.l && g.l.toLowerCase().indexOf("calent")>=0;
        html += '<div class="ex-group'+(isC?" warmup":"")+'" id="grp-'+key+'">'+
          '<div class="group-info">'+
            (g.l?'<div class="group-label'+(isC?" warmup":"")+'">'+g.l+'</div>':'')+
            '<div class="group-sets'+(isC?" warmup":"")+'">'+g.s+'√ó'+g.r+'</div>'+
          '</div>'+
          renderWeightCtrl(key, val, isC?"#6B7280":C)+
        '</div>';
      });
      html += '</div>';
    }
    html += '</div>';
  });

  var totalComp = w.exercises.filter(function(e){return !e.hw;}).length;
  if(totalComp>0) html += '<div class="complement-footer">+ '+totalComp+' ejercicio'+(totalComp>1?"s":"")+ ' complementario'+(totalComp>1?"s":"")+'</div>';

  document.getElementById("exercises").innerHTML = html;
}

function renderWeightCtrl(key, val, color) {
  return '<div class="weight-ctrl">'+
    '<button class="w-btn" style="border-color:'+color+'35;background:'+color+'12;color:'+color+'"'+
      ' onpointerdown="startAdj(\''+key+'\', -0.1)" onpointerup="stopAdj()" onpointerleave="stopAdj()">‚àí</button>'+
    '<div class="w-val" id="wval-'+key+'">'+fmtW(val)+'</div>'+
    '<button class="w-btn" style="border-color:'+color+'35;background:'+color+'12;color:'+color+'"'+
      ' onpointerdown="startAdj(\''+key+'\', 0.1)" onpointerup="stopAdj()" onpointerleave="stopAdj()">+</button>'+
  '</div>';
}

function renderBottomBar() {
  var w = WORKOUTS[selDay];
  var isDone = !!completed[weekDate(selDay)];
  var btn = document.getElementById("finish-btn");
  btn.style.background = isDone ? "linear-gradient(135deg,#052e1c,#0a3d26)" : "linear-gradient(135deg,"+w.color+" 0%,"+w.color+"99 100%)";
  btn.style.color = isDone ? "#34D399" : "#fff";
  btn.style.boxShadow = isDone ? "none" : "0 8px 28px "+w.color+"50";
  btn.textContent = isDone ? "‚úì Actualizar entrenamiento" : "‚úì Finalizar entrenamiento";
}

function toggleEx(id) {
  expanded[id] = !expanded[id];
  renderExercises();
}

function startAdj(key, d) {
  doAdj(key, d);
  ivRef = setInterval(function(){ doAdj(key, d); }, 120);
}
function stopAdj() { clearInterval(ivRef); ivRef=null; }
function doAdj(key, d) {
  weights[key] = adj(weights[key], d);
  var el = document.getElementById("wval-"+key);
  if(el) el.textContent = fmtW(weights[key]);
}

function showToast(msg, type) {
  var t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "";
  if(type==="success"){ t.style.background="#052e1c"; t.style.borderColor="#34D399"; t.style.color="#34D399"; }
  else if(type==="warn"){ t.style.background="#2c1a05"; t.style.borderColor="#FBBF24"; t.style.color="#FBBF24"; }
  else { t.style.background="#12121E"; t.style.borderColor="#374151"; t.style.color="#9CA3AF"; }
  t.className="show";
  setTimeout(function(){ t.className=""; }, 2800);
}

function handleFinish() {
  var selDate = weekDate(selDay);
  storageSet("gymSess_"+selDate, weights);
  completed[selDate] = selDay;
  storageSet("gymCompleted", completed);
  renderRoutineHeader();
  renderBottomBar();
  showToast("¬°Sesi√≥n guardada! üí™","success");
}

function openChart(exId) {
  var w = WORKOUTS[selDay];
  var ex = w.exercises.find(function(e){return e.id===exId;});
  if(!ex) return;

  document.getElementById("modal-title").textContent = ex.name;

  // Load all sessions
  var data = {};
  Object.keys(localStorage).forEach(function(key){
    if(!key.startsWith("gymSess_")) return;
    try {
      var sess = JSON.parse(localStorage.getItem(key));
      var fullDate = key.replace("gymSess_","");
      var dateDisp = fullDate.slice(5);
      ex.groups.forEach(function(g,gi){
        if(g.dw===null) return;
        var k = ex.id+"_"+gi;
        if(sess[k]!==undefined){
          if(!data[gi]) data[gi]=[];
          data[gi].push({date:dateDisp, fullDate:fullDate, weight:sess[k]});
        }
      });
    }catch(e){}
  });
  Object.keys(data).forEach(function(gi){
    data[gi].sort(function(a,b){return a.fullDate.localeCompare(b.fullDate);});
  });

  var PALETTE = [w.color,"#34D399","#FBBF24","#F87171","#A78BFA"];
  var html = "";
  var hasData = Object.keys(data).length>0;

  if(!hasData) {
    html = '<div class="no-data"><div style="font-size:32px;margin-bottom:12px">üìà</div>'+
      '<div class="no-data-title">Sin registros a√∫n</div>'+
      '<div class="no-data-sub">Completa y guarda entrenamientos<br/>para ver tu progresi√≥n aqu√≠</div></div>';
  } else {
    // Simple SVG line chart
    var allDates = [];
    Object.values(data).forEach(function(arr){ arr.forEach(function(p){ if(allDates.indexOf(p.date)<0) allDates.push(p.date); }); });
    allDates.sort();

    if(allDates.length>1) {
      var W=320, H=140, pad=30;
      var allVals = [];
      Object.values(data).forEach(function(arr){ arr.forEach(function(p){ allVals.push(p.weight); }); });
      var minV=Math.min.apply(null,allVals), maxV=Math.max.apply(null,allVals);
      var rng = maxV-minV || 1;
      var xStep = (W-pad*2)/(allDates.length-1);
      function px(i){ return pad + i*xStep; }
      function py(v){ return H - pad - ((v-minV)/rng)*(H-pad*2); }

      var svgLines = "";
      Object.keys(data).forEach(function(gi){
        var col = PALETTE[gi%PALETTE.length];
        var pts = [];
        data[gi].forEach(function(p){ var i=allDates.indexOf(p.date); pts.push(px(i)+","+py(p.weight)); });
        if(pts.length>1) svgLines += '<polyline points="'+pts.join(" ")+'" fill="none" stroke="'+col+'" stroke-width="2.5" stroke-linecap="round"/>';
        data[gi].forEach(function(p){ var i=allDates.indexOf(p.date); svgLines += '<circle cx="'+px(i)+'" cy="'+py(p.weight)+'" r="3" fill="'+col+'"/>'; });
      });

      // x-axis labels
      var xLabels = "";
      allDates.forEach(function(d,i){
        xLabels += '<text x="'+px(i)+'" y="'+(H-8)+'" text-anchor="middle" fill="#374151" font-size="9">'+d+'</text>';
      });

      html += '<div class="chart-wrap"><svg width="100%" viewBox="0 0 '+W+' '+H+'" xmlns="http://www.w3.org/2000/svg">'+
        '<line x1="'+pad+'" y1="'+(H-pad)+'" x2="'+(W-pad)+'" y2="'+(H-pad)+'" stroke="#1A1A28" stroke-width="1"/>'+
        xLabels + svgLines +
        '</svg></div>';
    }

    // Stats
    Object.keys(data).forEach(function(gi){
      var col = PALETTE[gi%PALETTE.length];
      var g = ex.groups[gi];
      var ws = data[gi].map(function(p){return p.weight;});
      var max = Math.max.apply(null,ws);
      var latest = ws[ws.length-1];
      var diff = parseFloat((latest-ws[0]).toFixed(2));
      html += '<div class="stat-card" style="border-color:'+col+'20">'+
        '<div class="stat-bar" style="background:'+col+'"></div>'+
        '<div style="flex:1">'+
          '<div class="stat-label">'+(g.l||("Serie "+(parseInt(gi)+1)))+" ¬∑ "+g.s+"√ó"+g.r+'</div>'+
          '<div class="stat-nums">'+
            '<div><div class="stat-item-label">M√ÅXIMO</div><div class="stat-item-val" style="color:#E2E8F0">'+fmtW(max)+'</div></div>'+
            '<div><div class="stat-item-label">ACTUAL</div><div class="stat-item-val" style="color:#E2E8F0">'+fmtW(latest)+'</div></div>'+
            '<div><div class="stat-item-label">PROGRESO</div><div class="stat-item-val" style="color:'+(diff>=0?"#34D399":"#F87171")+'">'+(diff>=0?"+":"")+diff+" kg"+'</div></div>'+
          '</div>'+
        '</div>'+
      '</div>';
    });
  }

  document.getElementById("modal-body").innerHTML = html;
  document.getElementById("modal").className = "show";
}

function closeModal() {
  document.getElementById("modal").className = "";
}

// START
init();
</script>
</body>
</html>
